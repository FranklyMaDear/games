<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î£ÎºÎ¬ÎºÎ¹ Deluxe Pro - Î ÏÎ¿Ï†Î­ÏƒÎ¹Î¿Î½Î±Î» AI</title>
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="index.png">
    <link rel="icon" type="image/png" sizes="32x32" href="index.png">
    <link rel="icon" type="image/png" sizes="16x16" href="index.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#1e3c72">
    
    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3186700611266549"
            crossorigin="anonymous"></script>
    
    <style>
        :root {
            --board-size: min(95vw, 95vh, 800px);
            --square-size: calc(var(--board-size) / 8);
            --piece-size: calc(var(--square-size) * 0.85);
            --dot-size: calc(var(--square-size) * 0.25);
        }
        
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            font-family: "Segoe UI", sans-serif;
            overflow: hidden;
            position: relative;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1400px;
            gap: 20px;
        }

        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #3a2e16;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0,0,0,0.4);
            width: var(--board-size);
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .board {
            width: var(--board-size);
            height: var(--board-size);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            border: 6px solid #3a2e16;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .square {
            position: relative;
            width: var(--square-size);
            height: var(--square-size);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sq-light { background: #f0d9b5; }
        .sq-dark { background: #b58863; }

        .piece {
            width: var(--piece-size);
            height: var(--piece-size);
            cursor: grab;
            transition: transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .piece:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .highlight {
            box-shadow: inset 0 0 0 4px #ffcb2e;
        }

        .move-dot::after {
            content: '';
            position: absolute;
            width: var(--dot-size);
            height: var(--dot-size);
            border-radius: 50%;
            background: rgba(0,0,0,0.25);
        }

        .check {
            box-shadow: inset 0 0 0 4px #ff0000;
        }

        h1 {
            color: #fff;
            font-size: clamp(18px, 5vw, 24px);
            margin: 5px 0;
            text-align: center;
        }

        .controls {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }

        button {
            padding: 10px 16px;
            border: none;
            background: #d19a4c;
            color: white;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-size: clamp(14px, 4vw, 16px);
            min-width: 120px;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        button:hover, button:active { 
            background: #e0ad61; 
        }
        
        .game-info {
            color: white;
            margin: 8px 0;
            font-size: clamp(14px, 4vw, 16px);
            text-align: center;
            min-height: 24px;
        }
        
        /* FULLSCREEN POPUP AD - Î‘Ï€ÏŒ Ï„Î¿ ÎšÎ‘Î¤Î© ÏƒÏ„Î¿ Î Î‘ÎÎ© */
        .fullscreen-ad {
            position: fixed;
            bottom: -100vh;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.97);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: bottom 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }
        
        .fullscreen-ad.show {
            bottom: 0;
        }
        
        .fullscreen-ad.show-abrupt {
            bottom: 0;
            transition: none;
        }
        
        .ad-header {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 0 20px;
        }
        
        .ad-title {
            color: #ffcb2e;
            font-size: 26px;
            font-weight: bold;
            text-shadow: 0 2px 15px rgba(0,0,0,0.7);
            margin: 0;
        }
        
        .ad-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .ad-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .ad-container {
            width: 100%;
            max-width: 1200px;
            height: 600px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 15px 60px rgba(0,0,0,0.6);
            border: 4px solid #ffcb2e;
            position: relative;
        }
        
        .ad-close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 32px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .ad-close-btn:hover {
            background: rgba(255, 0, 0, 0.4);
            border-color: #ff0000;
            transform: rotate(90deg) scale(1.1);
        }
        
        .ad-footer {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            padding: 0 20px;
            font-weight: 500;
        }
        
        .ad-timer {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            padding: 0 20px;
        }
        
        /* Mid-game Ad Indicator */
        .midgame-ad-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(209, 154, 76, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 999;
            display: none;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal-content {
            background: #3a2e16;
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            width: 450px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border: 3px solid #d19a4c;
        }
        
        .modal h2 {
            color: #ffcb2e;
            margin-top: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        
        .start-btn {
            background: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .start-btn:hover {
            background: #45a049;
        }
        
        .thinking {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 10;
            display: none;
        }
        
        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .difficulty-btn {
            background: #5d4037;
        }
        
        .difficulty-btn.active {
            background: #d19a4c;
        }
        
        .game-mode-btn {
            background: #2a5298;
        }
        
        .game-mode-btn.active {
            background: #d19a4c;
        }
        
        .status-check {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .status-mate {
            color: #ff0000;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        /* Post-Game Modal */
        .post-game-modal .modal-content {
            width: 500px;
        }
        
        .post-game-title {
            color: gold;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .post-game-message {
            color: #fff;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .post-game-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .play-again-btn {
            background: #4CAF50;
        }
        
        .main-menu-btn {
            background: #8b4513;
        }
        
        /* Celebration Styles */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f00;
            opacity: 0.8;
            animation: fall linear forwards;
        }
        
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .victory-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 201;
            text-align: center;
            display: none;
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
            border: 2px solid gold;
        }
        
        .victory-message h2 {
            margin: 0 0 10px 0;
            color: gold;
        }
        
        .victory-message p {
            margin: 0;
        }
        
        /* Promotion Modal */
        .promotion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .promotion-options {
            display: flex;
            gap: 10px;
            background: #3a2e16;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        
        .promotion-piece {
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #5d4037;
        }
        
        .promotion-piece:hover {
            transform: scale(1.1);
            background: #d19a4c;
        }
        
        .promotion-piece img {
            width: 80%;
            height: 80%;
        }
        
        /* Board Wrapper */
        .board-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* AI Thinking Indicator */
        .ai-thinking {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 10;
            display: none;
        }
        
        /* AI Strength Indicator */
        .ai-strength {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 5px 10px;
            margin-top: 5px;
            font-size: 14px;
        }

        /* Responsive for mobile */
        @media (max-width: 768px) {
            .ad-container {
                height: 450px;
                max-width: 95%;
                border-width: 3px;
            }
            
            .ad-title {
                font-size: 22px;
            }
            
            .ad-subtitle {
                font-size: 16px;
            }
            
            .ad-close-btn {
                top: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 28px;
            }
            
            .ad-footer {
                font-size: 14px;
                bottom: 30px;
            }
            
            .ad-timer {
                font-size: 16px;
                bottom: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .ad-container {
                height: 350px;
                border-radius: 15px;
            }
            
            .ad-title {
                font-size: 20px;
            }
            
            .ad-subtitle {
                font-size: 14px;
            }
            
            .ad-close-btn {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 24px;
            }
            
            .midgame-ad-indicator {
                top: 10px;
                right: 10px;
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .promotion-options {
                padding: 10px;
            }
            
            .promotion-piece {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Mid-game Ad Indicator -->
    <div class="midgame-ad-indicator" id="midgameAdIndicator">
        ğŸ•’ Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î´Î¹Î±Ï†Î®Î¼Î¹ÏƒÎ· ÏƒÎµ: <span id="midgameTimer">120</span> Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
    </div>

    <div class="container">
        <!-- ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÏƒÎºÎ±ÎºÎ¹Î­ÏÎ± -->
        <div class="board-wrapper">
            <div class="board-container">
                <h1>â™• Î£ÎºÎ¬ÎºÎ¹ Deluxe Pro â™›</h1>
                <div class="game-info" id="gameInfo">Î Î±Î¯Î¶Î¿Ï…Î½ Ï„Î± Î›ÎµÏ…ÎºÎ¬</div>
                <div id="board" class="board"></div>
                <div class="ai-thinking" id="aiThinkingIndicator">
                    <div>ğŸ¤– Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹...</div>
                    <div id="aiDepthInfo" style="font-size: 12px; opacity: 0.8;">Î’Î¬Î¸Î¿Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚: 0</div>
                </div>
                <div class="controls">
                    <button id="resetBtn">ÎÎ­Î± Î Î±ÏÏ„Î¯Î´Î±</button>
                    <button id="flipBtn">Î‘Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
                    <button id="aiBtn">Î Î±Î¯Î¾Ï„Îµ Î¼Îµ AI</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FULLSCREEN POPUP AD (ÎšÎ‘Î¤Î© â†’ Î Î‘ÎÎ©) -->
    <div class="fullscreen-ad" id="fullscreenAd">
        <button class="ad-close-btn" id="closeFullscreenAd">Ã—</button>
        
        <div class="ad-header">
            <h2 class="ad-title">ğŸ® Î£ÎºÎ¬ÎºÎ¹ Deluxe Pro</h2>
            <p class="ad-subtitle">Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Îµ Ï„Î¿ Î´Ï‰ÏÎµÎ¬Î½ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ Î¼Îµ Î¼Î¹Î± Î¼Î¹ÎºÏÎ® ÎµÏ€Î¹ÏƒÎºÎµÏˆÎ® ÏƒÏ„Î· Î´Î¹Î±Ï†Î®Î¼Î¹ÏƒÎ·!</p>
        </div>
        
        <div class="ad-content">
            <div class="ad-container">
                <!-- GOOGLE FULLSCREEN AD -->
                <ins class="adsbygoogle"
                     style="display:block; width:100%; height:100%;"
                     data-ad-client="ca-pub-3186700611266549"
                     data-ad-slot="9660744817"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
        </div>
        
        <div class="ad-timer" id="adTimer">Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ ÏƒÎµ: <span id="adTimerCount">15</span> Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±</div>
        <div class="ad-footer">ÎšÎ»ÎµÎ¯ÏƒÏ„Îµ Ï„Î· Î´Î¹Î±Ï†Î®Î¼Î¹ÏƒÎ· Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ ÏƒÏ„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹</div>
    </div>
    
    <!-- Thinking Indicator -->
    <div class="thinking" id="thinkingIndicator">Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹...</div>
    
    <!-- Welcome Modal -->
    <div class="modal" id="welcomeModal">
        <div class="modal-content">
            <h2>â™• Î£ÎºÎ¬ÎºÎ¹ Deluxe Pro â™›</h2>
            <p style="color: #fff; margin-bottom: 20px;">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏŒÏ€Î¿ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï:</p>
            
            <div class="modal-options">
                <button class="modal-btn game-mode-btn active" data-mode="twoPlayers">Î”ÏÎ¿ Î Î±Î¯ÎºÏ„ÎµÏ‚</button>
                <button class="modal-btn game-mode-btn" data-mode="vsAI">Î Î±Î¯Î¾Ï„Îµ Î¼Îµ AI</button>
            </div>
            
            <div class="difficulty-selector" id="difficultySelector" style="display: none;">
                <h3 style="color: white; margin: 10px 0;">Î•Ï€Î¹Î»Î¿Î³Î® Î”Ï…ÏƒÎºÎ¿Î»Î¯Î±Ï‚</h3>
                <button class="modal-btn difficulty-btn" data-depth="1">ÎÎµÎ¿Ï†ÏÏ„Î¹ÏƒÏ„Î¿Ï‚</button>
                <button class="modal-btn difficulty-btn" data-depth="2">Î•ÏÎºÎ¿Î»Î¿</button>
                <button class="modal-btn difficulty-btn" data-depth="3">ÎœÎ­Ï„ÏÎ¹Î¿</button>
                <button class="modal-btn difficulty-btn active" data-depth="4">Î”ÏÏƒÎºÎ¿Î»Î¿</button>
                <button class="modal-btn difficulty-btn" data-depth="5">Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿</button>
                <button class="modal-btn difficulty-btn" data-depth="6">Î ÏÎ¿Ï†Î­ÏƒÎ¹Î¿Î½Î±Î»</button>
                <div class="ai-strength" id="aiStrengthInfo">
                    Î’Î¬Î¸Î¿Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚: 4<br>
                    Î§ÏÏŒÎ½Î¿Ï‚: ~2-5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
                </div>
            </div>
            
            <button class="modal-btn start-btn" id="startGameBtn">ÎˆÎ½Î±ÏÎ¾Î· Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</button>
        </div>
    </div>
    
    <!-- Post-Game Modal -->
    <div class="modal post-game-modal" id="postGameModal" style="display: none;">
        <div class="modal-content">
            <h2 class="post-game-title" id="postGameTitle">ğŸ‰ Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î±!</h2>
            <p class="post-game-message" id="postGameMessage"></p>
            
            <div class="post-game-buttons">
                <button class="modal-btn play-again-btn" id="playAgainBtn">ÎÎ­Î± Î Î±ÏÏ„Î¯Î´Î± â™Ÿï¸</button>
                <button class="modal-btn main-menu-btn" id="mainMenuBtn">ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÎœÎµÎ½Î¿Ï ğŸ </button>
            </div>
        </div>
    </div>
    
    <!-- Promotion Modal -->
    <div class="promotion-modal" id="promotionModal">
        <div class="promotion-options" id="promotionOptions">
            <!-- Promotion pieces will be added dynamically -->
        </div>
    </div>
    
    <!-- Celebration and Victory -->
    <div id="celebration" class="celebration"></div>
    <div id="victoryMessage" class="victory-message">
        <h2>ÎÎ¯ÎºÎ·!</h2>
        <p id="winnerText"></p>
    </div>

    <script>
        // ============================================
        // ÎšÎŸÎÎ£Î¤Î‘ÎÎ¤Î•Î£ ÎšÎ‘Î™ ÎœÎ•Î¤Î‘Î’Î›Î—Î¤Î•Î£
        // ============================================
        const boardEl = document.getElementById("board");
        const gameInfoEl = document.getElementById("gameInfo");
        const thinkingIndicator = document.getElementById("thinkingIndicator");
        const aiThinkingIndicator = document.getElementById("aiThinkingIndicator");
        const aiDepthInfo = document.getElementById("aiDepthInfo");
        const aiStrengthInfo = document.getElementById("aiStrengthInfo");
        const welcomeModal = document.getElementById("welcomeModal");
        const postGameModal = document.getElementById("postGameModal");
        const promotionModal = document.getElementById("promotionModal");
        const promotionOptions = document.getElementById("promotionOptions");
        const victoryMessageEl = document.getElementById("victoryMessage");
        const winnerTextEl = document.getElementById("winnerText");
        const celebrationEl = document.getElementById("celebration");
        
        // Ad Elements
        const fullscreenAd = document.getElementById("fullscreenAd");
        const closeFullscreenAd = document.getElementById("closeFullscreenAd");
        const adTimerCount = document.getElementById("adTimerCount");
        const midgameAdIndicator = document.getElementById("midgameAdIndicator");
        const midgameTimer = document.getElementById("midgameTimer");
        
        // UI Elements
        const postGameTitle = document.getElementById("postGameTitle");
        const postGameMessage = document.getElementById("postGameMessage");
        const playAgainBtn = document.getElementById("playAgainBtn");
        const mainMenuBtn = document.getElementById("mainMenuBtn");
        
        // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
        let selectedGameMode = 'twoPlayers';
        let selectedDifficulty = 4;
        
        // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
        let board = [];
        let whiteToMove = true;
        let selected = null;
        let legalMoves = [];
        let flipped = false;
        let vsAI = false;
        let aiColor = 'b';
        let gameActive = true;
        let aiDepth = 4;
        let kingInCheck = false;
        let promotionPending = null;
        let moveHistory = [];
        let castlingRights = { whiteKingside: true, whiteQueenside: true, blackKingside: true, blackQueenside: true };
        let enPassantTarget = null;
        
        // Ad Variables
        let adShown = false;
        let midgameAdShown = false;
        let gameStartTime = null;
        let adTimer;
        let adCountdownTimer;
        let midgameCountdownTimer;
        let midgameAdTimeout;
        let adCountdownValue = 15;
        
        // AI Variables
        let transpositionTable = {};
        let nodesEvaluated = 0;
        let searchDepth = 0;
        let currentSearchDepth = 0;
        let searchStartTime = 0;
        
        // Î‘Î¡Î§Î™ÎšÎ— Î˜Î•Î£Î—
        const START = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];
        
        // Î‘ÎÎ™Î•Î£ ÎšÎŸÎœÎœÎ‘Î¤Î™Î©Î
        const PIECE_VALUES = {
            'p': 100, 'n': 320, 'b': 330, 'r': 500, 'q': 900, 'k': 20000
        };
        
        // Î Î™ÎÎ‘ÎšÎ•Î£ Î˜Î•Î£Î—Î£ Î“Î™Î‘ ÎšÎ‘Î˜Î• ÎšÎŸÎœÎœÎ‘Î¤Î™
        const POSITION_TABLES = {
            'p': [
                [0,   0,   0,   0,   0,   0,   0,   0],
                [50,  50,  50,  50,  50,  50,  50,  50],
                [10,  10,  20,  30,  30,  20,  10,  10],
                [5,   5,  10,  25,  25,  10,   5,   5],
                [0,   0,   0,  20,  20,   0,   0,   0],
                [5,  -5, -10,   0,   0, -10,  -5,   5],
                [5,  10,  10, -20, -20,  10,  10,   5],
                [0,   0,   0,   0,   0,   0,   0,   0]
            ],
            'n': [
                [-50, -40, -30, -30, -30, -30, -40, -50],
                [-40, -20,   0,   0,   0,   0, -20, -40],
                [-30,   0,  10,  15,  15,  10,   0, -30],
                [-30,   5,  15,  20,  20,  15,   5, -30],
                [-30,   0,  15,  20,  20,  15,   0, -30],
                [-30,   5,  10,  15,  15,  10,   5, -30],
                [-40, -20,   0,   5,   5,   0, -20, -40],
                [-50, -40, -30, -30, -30, -30, -40, -50]
            ],
            'b': [
                [-20, -10, -10, -10, -10, -10, -10, -20],
                [-10,   0,   0,   0,   0,   0,   0, -10],
                [-10,   0,   5,  10,  10,   5,   0, -10],
                [-10,   5,   5,  10,  10,   5,   5, -10],
                [-10,   0,  10,  10,  10,  10,   0, -10],
                [-10,  10,  10,  10,  10,  10,  10, -10],
                [-10,   5,   0,   0,   0,   0,   5, -10],
                [-20, -10, -10, -10, -10, -10, -10, -20]
            ],
            'r': [
                [0,   0,   0,   5,   5,   0,   0,   0],
                [-5,   0,   0,   0,   0,   0,   0,  -5],
                [-5,   0,   0,   0,   0,   0,   0,  -5],
                [-5,   0,   0,   0,   0,   0,   0,  -5],
                [-5,   0,   0,   0,   0,   0,   0,  -5],
                [-5,   0,   0,   0,   0,   0,   0,  -5],
                [5,  10,  10,  10,  10,  10,  10,   5],
                [0,   0,   0,   0,   0,   0,   0,   0]
            ],
            'q': [
                [-20, -10, -10,  -5,  -5, -10, -10, -20],
                [-10,   0,   0,   0,   0,   0,   0, -10],
                [-10,   0,   5,   5,   5,   5,   0, -10],
                [-5,   0,   5,   5,   5,   5,   0,  -5],
                [0,   0,   5,   5,   5,   5,   0,  -5],
                [-10,   5,   5,   5,   5,   5,   0, -10],
                [-10,   0,   5,   0,   0,   0,   0, -10],
                [-20, -10, -10,  -5,  -5, -10, -10, -20]
            ],
            'k': [
                [-30, -40, -40, -50, -50, -40, -40, -30],
                [-30, -40, -40, -50, -50, -40, -40, -30],
                [-30, -40, -40, -50, -50, -40, -40, -30],
                [-30, -40, -40, -50, -50, -40, -40, -30],
                [-20, -30, -30, -40, -40, -30, -30, -20],
                [-10, -20, -20, -20, -20, -20, -20, -10],
                [20,  20,   0,   0,   0,   0,  20,  20],
                [20,  30,  10,   0,   0,  10,  30,  20]
            ],
            'k_endgame': [
                [-50, -40, -30, -20, -20, -30, -40, -50],
                [-30, -20, -10,   0,   0, -10, -20, -30],
                [-30, -10,  20,  30,  30,  20, -10, -30],
                [-30, -10,  30,  40,  40,  30, -10, -30],
                [-30, -10,  30,  40,  40,  30, -10, -30],
                [-30, -10,  20,  30,  30,  20, -10, -30],
                [-30, -30,   0,   0,   0,   0, -30, -30],
                [-50, -30, -30, -30, -30, -30, -30, -50]
            ]
        };
        
        // ============================================
        // Î‘Î¡Î§Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— Î Î‘Î™Î§ÎÎ™Î”Î™ÎŸÎ¥
        // ============================================
        function initGame() {
            // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„ÏÎ½ Î²Î¬ÏƒÎµÎ¹ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½
            vsAI = (selectedGameMode === 'vsAI');
            
            // Î‘Î½Î±Î²Î¬Î¸Î¼Î¹ÏƒÎ· AI Î²Î¬ÏƒÎµÎ¹ Î´Ï…ÏƒÎºÎ¿Î»Î¯Î±Ï‚
            searchDepth = getSearchDepth(selectedDifficulty);
            updateAIStrengthInfo();
            
            if (vsAI) {
                aiColor = Math.random() > 0.5 ? 'b' : 'w';
            }
            
            // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÎºÎ±ÎºÎ¹Î­ÏÎ±Ï‚
            board = [];
            for (let r = 0; r < 8; r++) {
                board[r] = [];
                for (let c = 0; c < 8; c++) {
                    const ch = START[r][c];
                    if (!ch) {
                        board[r][c] = null;
                    } else {
                        const color = ch === ch.toUpperCase() ? 'w' : 'b';
                        const type = ch.toLowerCase();
                        board[r][c] = { type, color };
                    }
                }
            }
            
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¼ÎµÏ„Î±Î²Î»Î·Ï„ÏÎ½
            whiteToMove = true;
            selected = null;
            legalMoves = [];
            gameActive = true;
            kingInCheck = false;
            promotionPending = null;
            gameStartTime = Date.now();
            moveHistory = [];
            nodesEvaluated = 0;
            
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÎµÎºÏ„ÏÎ¿Ï€Î®Ï‚
            castlingRights = { 
                whiteKingside: true, 
                whiteQueenside: true, 
                blackKingside: true, 
                blackQueenside: true 
            };
            enPassantTarget = null;
            
            updateGameInfo();
            render();
            
            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€ÏÏÏ„Î·Ï‚ FULLSCREEN AD Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 2 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
            if (!adShown) {
                setTimeout(() => {
                    showFullscreenAd("startup");
                }, 2000);
            }
            
            // Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î³Î¹Î± mid-game ad
            startMidgameAdCountdown();
        }
        
        // ============================================
        // Î‘Î ÎŸÎ”ÎŸÎ£Î— Î£ÎšÎ‘ÎšÎ™Î•Î¡Î‘Î£
        // ============================================
        function render() {
            boardEl.innerHTML = "";
            const rows = [...Array(8).keys()];
            if (flipped) rows.reverse();
            
            // Î’ÏÎµÏ‚ Î±Î½ Î¿ Î²Î±ÏƒÎ¹Î»Î¹Î¬Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ ÏƒÎ±Ï‡
            let kingInCheckPos = null;
            if (kingInCheck) {
                const currentColor = whiteToMove ? 'w' : 'b';
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const piece = board[r][c];
                        if (piece && piece.type === 'k' && piece.color === currentColor) {
                            kingInCheckPos = { r, c };
                            break;
                        }
                    }
                    if (kingInCheckPos) break;
                }
            }
            
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„ÎµÏ„ÏÎ±Î³ÏÎ½Ï‰Î½
            for (let rr of rows) {
                const row = rr;
                const cols = flipped ? [7, 6, 5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5, 6, 7];
                
                for (let cc of cols) {
                    const col = cc;
                    const sq = document.createElement("div");
                    sq.className = "square " + ((row + col) % 2 === 0 ? "sq-dark" : "sq-light");
                    sq.dataset.r = row;
                    sq.dataset.c = col;
                    
                    // Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î±Î½ Î¿ Î²Î±ÏƒÎ¹Î»Î¹Î¬Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ ÏƒÎ±Ï‡
                    if (kingInCheckPos && kingInCheckPos.r === row && kingInCheckPos.c === col) {
                        sq.classList.add("check");
                    }
                    
                    // Î ÏÎ¿Î²Î¿Î»Î® Ï€Î¹Î¸Î±Î½ÏÎ½ ÎºÎ¹Î½Î®ÏƒÎµÏ‰Î½
                    const move = legalMoves.find(m => m.r === row && m.c === col);
                    if (move) sq.classList.add("move-dot");
                    
                    // Î ÏÎ¿Î²Î¿Î»Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï… Ï„ÎµÏ„ÏÎ±Î³ÏÎ½Î¿Ï…
                    if (selected && selected.r === row && selected.c === col) {
                        sq.classList.add("highlight");
                    }
                    
                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎºÎ¿Î¼Î¼Î±Ï„Î¹Î¿Ï (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
                    const p = board[row][col];
                    if (p) {
                        const img = document.createElement("img");
                        img.src = getPieceImg(p.type, p.color);
                        img.className = "piece";
                        img.draggable = true;
                        img.alt = `${p.color === 'w' ? 'Î›ÎµÏ…ÎºÏŒ' : 'ÎœÎ±ÏÏÎ¿'} ${getPieceName(p.type)}`;
                        
                        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event listeners Î¼ÏŒÎ½Î¿ Î±Î½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î· ÎºÎ¯Î½Î·ÏƒÎ·
                        if (!vsAI || (vsAI && whiteToMove !== (aiColor === 'w'))) {
                            img.addEventListener("click", (e) => {
                                e.stopPropagation();
                                onSquareTap(row, col);
                            });
                        }
                        
                        sq.appendChild(img);
                    }
                    
                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event ÏƒÏ„Î¿ Ï„ÎµÏ„ÏÎ¬Î³Ï‰Î½Î¿
                    if (!vsAI || (vsAI && whiteToMove !== (aiColor === 'w'))) {
                        sq.addEventListener("click", () => onSquareTap(row, col));
                    }
                    
                    boardEl.appendChild(sq);
                }
            }
            
            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÎµÎ¹ÏÎ¬ Ï„Î¿Ï… AI, Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Ï„Î·Î½ ÎºÎ¯Î½Î·ÏƒÎ· Ï„Î¿Ï…
            if (vsAI && gameActive && whiteToMove === (aiColor === 'w')) {
                setTimeout(() => {
                    thinkingIndicator.style.display = 'block';
                    aiThinkingIndicator.style.display = 'flex';
                    makeAIMove();
                }, 500);
            }
        }
        
        // ============================================
        // Î§Î•Î™Î¡Î™Î£ÎœÎŸÎ£ ÎšÎ™ÎÎ—Î£Î•Î©Î
        // ============================================
        function onSquareTap(r, c) {
            if (!gameActive) return;
            if (vsAI && whiteToMove === (aiColor === 'w')) return;
            
            // Î‘Î½ Î­Ï‡ÎµÎ¹ Î®Î´Î· ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹ ÎºÎ±Î¹ Ï„Î¿ Î½Î­Î¿ Ï„ÎµÏ„ÏÎ¬Î³Ï‰Î½Î¿ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ· ÎºÎ¯Î½Î·ÏƒÎ·
            if (selected && legalMoves.find(m => m.r === r && m.c === c)) {
                movePiece(selected.r, selected.c, r, c);
                selected = null;
                legalMoves = [];
                render();
                return;
            }
            
            // Î•Ï€Î¹Î»Î¿Î³Î® Î½Î­Î¿Ï… ÎºÎ¿Î¼Î¼Î±Ï„Î¹Î¿Ï
            const p = board[r][c];
            if (p && p.color === (whiteToMove ? 'w' : 'b')) {
                selected = { r, c };
                legalMoves = generateLegalMoves(r, c);
            } else {
                selected = null;
                legalMoves = [];
            }
            render();
        }
        
        function movePiece(sr, sc, tr, tc) {
            const movingPiece = board[sr][sc];
            const capturedPiece = board[tr][tc];
            const move = {
                from: { r: sr, c: sc },
                to: { r: tr, c: tc },
                piece: movingPiece.type,
                color: movingPiece.color,
                captured: capturedPiece,
                castling: null,
                enPassant: false,
                promotion: null
            };
            
            // Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î³Î¹Î± ÎµÎºÏ„ÏÎ¿Ï€Î®
            if (movingPiece.type === 'k' && Math.abs(tc - sc) === 2) {
                move.castling = tc > sc ? 'kingside' : 'queenside';
                handleCastling(sr, sc, tr, tc, movingPiece.color);
            } else if (movingPiece.type === 'p' && Math.abs(tc - sc) === 1 && !capturedPiece) {
                // En passant capture
                move.enPassant = true;
                board[sr][tc] = null; // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„Î¿Ï… Ï€Î¹Î¿Î½Î¹Î¿Ï Ï€Î¿Ï… ÏƒÏ…Î»Î»Î±Î¼Î²Î¬Î½ÎµÏ„Î±Î¹ en passant
            }
            
            // ÎœÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ· ÎºÎ¿Î¼Î¼Î±Ï„Î¹Î¿Ï
            board[tr][tc] = movingPiece;
            board[sr][sc] = null;
            
            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÎµÎºÏ„ÏÎ¿Ï€Î®Ï‚
            updateCastlingRights(movingPiece, sr, sc);
            
            // Î•Ï€Î¯Ï€ÏÏ‰ÏƒÎ· Ï€Î¹Î¿Î½Î¹Î¿Ï
            if (movingPiece.type === 'p') {
                if ((movingPiece.color === 'w' && tr === 0) || (movingPiece.color === 'b' && tr === 7)) {
                    promotionPending = { r: tr, c: tc };
                    showPromotionOptions(movingPiece.color);
                    move.promotion = 'pending';
                    moveHistory.push(move);
                    return;
                }
                
                // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„ÎµÏ„ÏÎ±Î³ÏÎ½Î¿Ï… Î³Î¹Î± en passant
                if (Math.abs(tr - sr) === 2) {
                    enPassantTarget = { r: (sr + tr) / 2, c: tc };
                } else {
                    enPassantTarget = null;
                }
            } else {
                enPassantTarget = null;
            }
            
            // Î‘Î»Î»Î±Î³Î® ÏƒÎµÎ¹ÏÎ¬Ï‚
            whiteToMove = !whiteToMove;
            moveHistory.push(move);
            
            // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
            checkGameState();
            updateGameInfo();
            
            // Render Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Î¼Î¹ÎºÏÎ® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ·
            setTimeout(render, 50);
        }
        
        // ============================================
        // Î•ÎšÎ¤Î¡ÎŸÎ Î— (CASTLING)
        // ============================================
        function handleCastling(kr, kc, tr, tc, color) {
            if (tc > kc) { // Kingside
                board[tr][tc - 1] = board[color === 'w' ? 7 : 0][7];
                board[color === 'w' ? 7 : 0][7] = null;
            } else { // Queenside
                board[tr][tc + 1] = board[color === 'w' ? 7 : 0][0];
                board[color === 'w' ? 7 : 0][0] = null;
            }
            
            // Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎµÎºÏ„ÏÎ¿Ï€Î®Ï‚ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï‡ÏÏÎ¼Î±
            if (color === 'w') {
                castlingRights.whiteKingside = false;
                castlingRights.whiteQueenside = false;
            } else {
                castlingRights.blackKingside = false;
                castlingRights.blackQueenside = false;
            }
        }
        
        function updateCastlingRights(piece, fromR, fromC) {
            if (piece.type === 'k') {
                if (piece.color === 'w') {
                    castlingRights.whiteKingside = false;
                    castlingRights.whiteQueenside = false;
                } else {
                    castlingRights.blackKingside = false;
                    castlingRights.blackQueenside = false;
                }
            } else if (piece.type === 'r') {
                if (piece.color === 'w') {
                    if (fromR === 7 && fromC === 0) castlingRights.whiteQueenside = false;
                    if (fromR === 7 && fromC === 7) castlingRights.whiteKingside = false;
                } else {
                    if (fromR === 0 && fromC === 0) castlingRights.blackQueenside = false;
                    if (fromR === 0 && fromC === 7) castlingRights.blackKingside = false;
                }
            }
        }
        
        // ============================================
        // Î•Î Î™Î Î¡Î©Î£Î— Î Î™ÎŸÎÎ™ÎŸÎ¥
        // ============================================
        function showPromotionOptions(color) {
            promotionOptions.innerHTML = '';
            
            const pieces = ['q', 'r', 'b', 'n'];
            pieces.forEach(pieceType => {
                const pieceOption = document.createElement("div");
                pieceOption.className = "promotion-piece";
                pieceOption.innerHTML = `<img src="${getPieceImg(pieceType, color)}" alt="${getPieceName(pieceType)}">`;
                pieceOption.addEventListener("click", () => {
                    promotePawn(promotionPending.r, promotionPending.c, pieceType);
                    promotionModal.style.display = 'none';
                });
                promotionOptions.appendChild(pieceOption);
            });
            
            promotionModal.style.display = 'flex';
        }
        
        function promotePawn(r, c, pieceType) {
            board[r][c].type = pieceType;
            promotionPending = null;
            
            // ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚
            whiteToMove = !whiteToMove;
            moveHistory[moveHistory.length - 1].promotion = pieceType;
            
            checkGameState();
            updateGameInfo();
            render();
        }
        
        // ============================================
        // Î Î¡ÎŸÎ§Î©Î¡Î—ÎœÎ•ÎÎŸ AI ÎœÎ• MINIMAX
        // ============================================
        function makeAIMove() {
            if (!gameActive) return;
            
            searchStartTime = Date.now();
            nodesEvaluated = 0;
            
            setTimeout(() => {
                const bestMove = findBestMove();
                
                if (bestMove) {
                    movePiece(bestMove.from.r, bestMove.from.c, bestMove.to.r, bestMove.to.c);
                    
                    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ AI
                    const timeTaken = (Date.now() - searchStartTime) / 1000;
                    console.log(`AI ÎºÎ¯Î½Î·ÏƒÎ·: ${nodesEvaluated} ÎºÏŒÎ¼Î²Î¿Î¹ ÏƒÎµ ${timeTaken.toFixed(2)} Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±, Î’Î¬Î¸Î¿Ï‚: ${currentSearchDepth}`);
                }
                
                thinkingIndicator.style.display = 'none';
                aiThinkingIndicator.style.display = 'none';
                render();
            }, 100);
        }
        
        function findBestMove() {
            const possibleMoves = getAllLegalMoves(aiColor);
            if (possibleMoves.length === 0) return null;
            
            // Iterative deepening
            let bestMove = null;
            let bestValue = -Infinity;
            const maxDepth = searchDepth;
            
            try {
                for (let depth = 1; depth <= maxDepth; depth++) {
                    currentSearchDepth = depth;
                    aiDepthInfo.textContent = `Î’Î¬Î¸Î¿Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚: ${depth}`;
                    
                    let alpha = -Infinity;
                    let beta = Infinity;
                    let currentBestMove = possibleMoves[0];
                    let currentBestValue = -Infinity;
                    
                    for (const move of possibleMoves) {
                        makeMove(move);
                        const moveValue = -negamax(depth - 1, -beta, -alpha, false);
                        undoMove(move);
                        
                        if (moveValue > currentBestValue) {
                            currentBestValue = moveValue;
                            currentBestMove = move;
                        }
                        
                        alpha = Math.max(alpha, moveValue);
                    }
                    
                    // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎºÎ±Î»ÏÏ„ÎµÏÎ·Ï‚ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚ Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ Ï„Î¿ Î²Î¬Î¸Î¿Ï‚
                    if (currentBestValue > bestValue) {
                        bestValue = currentBestValue;
                        bestMove = currentBestMove;
                    }
                    
                    // Î‘Î½ Î²ÏÎ®ÎºÎµ Î¼Î±Ï„, ÏƒÏ„Î±Î¼Î¬Ï„Î± Î½Ï‰ÏÎ¯Ï„ÎµÏÎ±
                    if (currentBestValue > 10000) break;
                    
                    // Î‘Î½ Ï€ÎµÏÎ½Î¬ÎµÎ¹ Ï€Î¿Î»ÏÏ‚ Ï‡ÏÏŒÎ½Î¿Ï‚, ÏƒÏ„Î±Î¼Î¬Ï„Î±
                    if ((Date.now() - searchStartTime) > 8000) break;
                }
            } catch (e) {
                console.log("AI error:", e);
            }
            
            // Î‘Î½ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ¯Î½Î·ÏƒÎ·, ÎµÏ€Î­Î»ÎµÎ¾Îµ Ï„Ï…Ï‡Î±Î¯Î±
            if (!bestMove && possibleMoves.length > 0) {
                bestMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
            }
            
            return bestMove;
        }
        
        function negamax(depth, alpha, beta, isMaximizing) {
            nodesEvaluated++;
            
            // Î‘Î½ Î­Ï†Ï„Î±ÏƒÎµ Ï„Î¿ Î²Î¬Î¸Î¿Ï‚ Î® Ï„ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹
            if (depth === 0) {
                return quiescenceSearch(alpha, beta, isMaximizing ? aiColor : (aiColor === 'w' ? 'b' : 'w'));
            }
            
            const color = isMaximizing ? aiColor : (aiColor === 'w' ? 'b' : 'w');
            const possibleMoves = getAllLegalMoves(color);
            
            // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚
            if (possibleMoves.length === 0) {
                if (isKingInCheck(color)) {
                    return -10000 + (searchDepth - depth); // ÎœÎ±Ï„
                }
                return 0; // Î Î±Ï„
            }
            
            // Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· ÎºÎ¹Î½Î®ÏƒÎµÏ‰Î½ Î³Î¹Î± ÎºÎ±Î»ÏÏ„ÎµÏÎ¿ pruning
            orderMoves(possibleMoves);
            
            let maxEval = -Infinity;
            
            for (const move of possibleMoves) {
                makeMove(move);
                const evalScore = -negamax(depth - 1, -beta, -alpha, !isMaximizing);
                undoMove(move);
                
                maxEval = Math.max(maxEval, evalScore);
                alpha = Math.max(alpha, evalScore);
                
                if (beta <= alpha) {
                    break; // Alpha-beta cutoff
                }
            }
            
            return maxEval;
        }
        
        function quiescenceSearch(alpha, beta, color) {
            let standPat = evaluatePosition();
            
            if (standPat >= beta) return beta;
            if (standPat > alpha) alpha = standPat;
            
            // Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¼ÏŒÎ½Î¿ Î³Î¹Î± ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Ï€Î±Î¯ÏÎ½Î¿Ï…Î½ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹Î±
            const captures = getAllCaptureMoves(color);
            
            for (const move of captures) {
                makeMove(move);
                const score = -quiescenceSearch(-beta, -alpha, color === 'w' ? 'b' : 'w');
                undoMove(move);
                
                if (score >= beta) return beta;
                if (score > alpha) alpha = score;
            }
            
            return alpha;
        }
        
        // ============================================
        // Î‘ÎÎ™ÎŸÎ›ÎŸÎ“Î—Î£Î— Î˜Î•Î£Î—Î£
        // ============================================
        function evaluatePosition() {
            let score = 0;
            
            // Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎºÎ¿Î¼Î¼Î±Ï„Î¹ÏÎ½ ÎºÎ±Î¹ Î¸Î­ÏƒÎ·Ï‚
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece) {
                        const pieceScore = getPieceScore(piece, r, c);
                        score += piece.color === aiColor ? pieceScore : -pieceScore;
                    }
                }
            }
            
            // Î£Ï„ÏÎ±Ï„Î·Î³Î¹ÎºÎ¿Î¯ Ï€Î±ÏÎ¬Î³Î¿Î½Ï„ÎµÏ‚
            score += evaluateMobility(aiColor) * 0.1;
            score += evaluatePawnStructure(aiColor) * 5;
            score += evaluateKingSafety(aiColor) * 3;
            score += evaluateCenterControl(aiColor) * 2;
            
            // Î¤Ï…Ï‡Î±Î¯Î± Î¼ÎµÏ„Î±Î²Î¿Î»Î® Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÏÎ³Î¿Ï…Î¼Îµ ÎµÏ€Î±Î½Î±Î»Î®ÏˆÎµÎ¹Ï‚
            score += Math.random() * 2 - 1;
            
            return score;
        }
        
        function getPieceScore(piece, row, col) {
            let score = PIECE_VALUES[piece.type];
            
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼Ï€ÏŒÎ½Î¿Ï…Ï‚ Î¸Î­ÏƒÎ·Ï‚
            const table = POSITION_TABLES[piece.type === 'k' && isEndgame() ? 'k_endgame' : piece.type];
            if (table) {
                const r = piece.color === 'w' ? 7 - row : row;
                const c = piece.color === 'w' ? col : 7 - col;
                score += table[r][c];
            }
            
            return score;
        }
        
        function evaluateMobility(color) {
            return getAllLegalMoves(color).length;
        }
        
        function evaluatePawnStructure(color) {
            let score = 0;
            
            for (let c = 0; c < 8; c++) {
                let pawnCount = 0;
                let isolated = true;
                
                for (let r = 0; r < 8; r++) {
                    const piece = board[r][c];
                    if (piece && piece.type === 'p' && piece.color === color) {
                        pawnCount++;
                        
                        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î´Î¹Ï€Î»Î¬ Ï€Î¹ÏŒÎ½Î¹Î±
                        if (pawnCount > 1) score -= 20;
                        
                        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î¼ÎµÎ¼Î¿Î½Ï‰Î¼Î­Î½Î± Ï€Î¹ÏŒÎ½Î¹Î±
                        if (c > 0) {
                            for (let rr = 0; rr < 8; rr++) {
                                const leftPiece = board[rr][c - 1];
                                if (leftPiece && leftPiece.type === 'p' && leftPiece.color === color) {
                                    isolated = false;
                                    break;
                                }
                            }
                        }
                        if (c < 7 && isolated) {
                            for (let rr = 0; rr < 8; rr++) {
                                const rightPiece = board[rr][c + 1];
                                if (rightPiece && rightPiece.type === 'p' && rightPiece.color === color) {
                                    isolated = false;
                                    break;
                                }
                            }
                        }
                        
                        if (isolated) score -= 15;
                        
                        // ÎœÏ€ÏŒÎ½Î¿Ï…Ï‚ Î³Î¹Î± Ï€ÏÎ¿Ï‰Î¸Î·Î¼Î­Î½Î± Ï€Î¹ÏŒÎ½Î¹Î±
                        if (color === 'w' && r <= 3) score += (7 - r) * 5;
                        if (color === 'b' && r >= 4) score += r * 5;
                    }
                }
            }
            
            return score;
        }
        
        function evaluateKingSafety(color) {
            const kingPos = findKing(color);
            if (!kingPos) return 0;
            
            let safety = 0;
            
            // Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î²Î±ÏƒÎ¹Î»Î¹Î¬ Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î· Ï†Î¬ÏƒÎ· Ï„Î¿Ï… Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
            if (isEndgame()) {
                // Î£Ï„Î¿ Ï„Î­Î»Î¿Ï‚, Î¿ Î²Î±ÏƒÎ¹Î»Î¹Î¬Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒÏ‚
                safety += (Math.abs(kingPos.r - 3.5) + Math.abs(kingPos.c - 3.5)) * -5;
            } else {
                // Î£Ï„Î·Î½ Î±ÏÏ‡Î®, Î¿ Î²Î±ÏƒÎ¹Î»Î¹Î¬Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÏ„Î±Î¹
                if (kingPos.r === (color === 'w' ? 7 : 0) && (kingPos.c === 4 || kingPos.c === 5)) {
                    safety += 30; // Î£Ï„Î¿ castling position
                }
            }
            
            // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± ÎºÎ¿Î½Ï„Î¹Î½Î¬ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹Î± Ï€Î¿Ï… Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î¿Î½ Î²Î±ÏƒÎ¹Î»Î¹Î¬
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const nr = kingPos.r + dr;
                    const nc = kingPos.c + dc;
                    if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                        const piece = board[nr][nc];
                        if (piece && piece.color === color) {
                            safety += 10;
                        }
                    }
                }
            }
            
            return safety;
        }
        
        function evaluateCenterControl(color) {
            const centerSquares = [[3, 3], [3, 4], [4, 3], [4, 4]];
            let control = 0;
            
            for (const [r, c] of centerSquares) {
                const piece = board[r][c];
                if (piece) {
                    control += piece.color === color ? 20 : -20;
                }
                
                // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± ÎºÎ¿Î¼Î¼Î¬Ï„Î¹Î± Ï€Î¿Ï… Î±Ï€ÎµÎ¹Î»Î¿ÏÎ½ Ï„Î¿ ÎºÎ­Î½Ï„ÏÎ¿
                for (let rr = 0; rr < 8; rr++) {
                    for (let cc = 0; cc < 8; cc++) {
                        const piece2 = board[rr][cc];
                        if (piece2 && piece2.color === color) {
                            const moves = generateMoves(rr, cc);
                            if (moves.some(m => m.r === r && m.c === c)) {
                                control += 5;
                            }
                        }
                    }
                }
            }
            
            return control;
        }
        
        function isEndgame() {
            let majorPieceCount = 0;
            let queenCount = 0;
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && piece.type !== 'p') {
                        if (piece.type === 'q') queenCount++;
                        if (piece.type === 'q' || piece.type === 'r') majorPieceCount++;
                    }
                }
            }
            
            return majorPieceCount <= 4 || queenCount === 0;
        }
        
        // ============================================
        // Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ AI
        // ============================================
        function getAllLegalMoves(color) {
            const moves = [];
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && piece.color === color) {
                        const pieceMoves = generateLegalMoves(r, c);
                        pieceMoves.forEach(move => {
                            moves.push({
                                from: { r, c },
                                to: move,
                                piece: piece.type,
                                color: piece.color,
                                captured: board[move.r]?.[move.c]
                            });
                        });
                    }
                }
            }
            
            return moves;
        }
        
        function getAllCaptureMoves(color) {
            return getAllLegalMoves(color).filter(move => move.captured);
        }
        
        function orderMoves(moves) {
            moves.sort((a, b) => {
                // ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Ï€Î±Î¯ÏÎ½Î¿Ï…Î½ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹ Ï€ÏÏÏ„Î± (MVV-LVA)
                const aValue = a.captured ? PIECE_VALUES[a.captured.type] - PIECE_VALUES[a.piece] / 10 : 0;
                const bValue = b.captured ? PIECE_VALUES[b.captured.type] - PIECE_VALUES[b.piece] / 10 : 0;
                
                if (bValue !== aValue) {
                    return bValue - aValue;
                }
                
                // ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Î´Î¯Î½Î¿Ï…Î½ ÏƒÎ±Ï‡
                const aCheck = moveGivesCheck(a) ? 50 : 0;
                const bCheck = moveGivesCheck(b) ? 50 : 0;
                
                return bCheck - aCheck;
            });
        }
        
        function moveGivesCheck(move) {
            makeMove(move);
            const opponentColor = move.color === 'w' ? 'b' : 'w';
            const givesCheck = isKingInCheck(opponentColor);
            undoMove(move);
            return givesCheck;
        }
        
        // ============================================
        // Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î— ÎšÎ™ÎÎ—Î£Î•Î©Î Î“Î™Î‘ AI
        // ============================================
        function makeMove(move) {
            const { from, to, piece, color, captured } = move;
            
            // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î³Î¹Î± undo
            move.prevPiece = board[to.r]?.[to.c];
            move.prevCastlingRights = { ...castlingRights };
            move.prevEnPassant = enPassantTarget;
            
            // ÎœÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ· ÎºÎ¿Î¼Î¼Î±Ï„Î¹Î¿Ï
            board[to.r][to.c] = board[from.r][from.c];
            board[from.r][from.c] = null;
            
            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÎµÎºÏ„ÏÎ¿Ï€Î®Ï‚
            if (piece === 'k') {
                if (color === 'w') {
                    castlingRights.whiteKingside = false;
                    castlingRights.whiteQueenside = false;
                } else {
                    castlingRights.blackKingside = false;
                    castlingRights.blackQueenside = false;
                }
            }
            
            // Î•Ï€Î¯Ï€ÏÏ‰ÏƒÎ· (Î±Ï€Î»Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· Î³Î¹Î± AI)
            if (piece === 'p' && (to.r === 0 || to.r === 7)) {
                board[to.r][to.c].type = 'q';
            }
        }
        
        function undoMove(move) {
            const { from, to, piece, color, prevPiece, prevCastlingRights, prevEnPassant } = move;
            
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÎ¿Î¼Î¼Î±Ï„Î¹Î¿Ï
            board[from.r][from.c] = board[to.r][to.c];
            board[to.r][to.c] = prevPiece;
            
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎµÏ€Î¯Ï€ÏÏ‰ÏƒÎ·Ï‚
            if (move.promotion) {
                board[from.r][from.c].type = 'p';
            }
            
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¼ÎµÏ„Î±Î²Î»Î·Ï„ÏÎ½
            castlingRights = prevCastlingRights;
            enPassantTarget = prevEnPassant;
        }
        
        // ============================================
        // ÎšÎ‘ÎÎŸÎÎ•Î£ Î£ÎšÎ‘ÎšÎ™ÎŸÎ¥
        // ============================================
        function generateLegalMoves(r, c) {
            const moves = generateMoves(r, c);
            return moves.filter(move => {
                const piece = board[r][c];
                const originalPiece = board[move.r][move.c];
                
                // Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® ÎºÎ¯Î½Î·ÏƒÎ·
                board[move.r][move.c] = piece;
                board[r][c] = null;
                
                const inCheck = isKingInCheck(piece.color);
                
                // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬
                board[r][c] = piece;
                board[move.r][move.c] = originalPiece;
                
                return !inCheck;
            });
        }
        
        function generateMoves(r, c) {
            const p = board[r][c];
            const moves = [];
            if (!p) return moves;
            
            const color = p.color;
            const dir = color === 'w' ? -1 : 1;
            
            function inBounds(rr, cc) { return rr >= 0 && rr < 8 && cc >= 0 && cc < 8; }
            function isEmpty(rr, cc) { return inBounds(rr, cc) && !board[rr][cc]; }
            function isEnemy(rr, cc) { return inBounds(rr, cc) && board[rr][cc] && board[rr][cc].color !== color; }
            
            // Î Î™ÎŸÎÎ™Î‘
            if (p.type === 'p') {
                // ÎœÏ€ÏÎ¿ÏƒÏ„Î¬ Î¼Î¯Î± Î¸Î­ÏƒÎ·
                if (isEmpty(r + dir, c)) {
                    moves.push({ r: r + dir, c });
                    
                    // ÎœÏ€ÏÎ¿ÏƒÏ„Î¬ Î´ÏÎ¿ Î¸Î­ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Î±ÏÏ‡Î¹ÎºÎ® Î¸Î­ÏƒÎ·
                    if ((color === 'w' && r === 6) || (color === 'b' && r === 1)) {
                        if (isEmpty(r + 2 * dir, c)) {
                            moves.push({ r: r + 2 * dir, c });
                        }
                    }
                }
                
                // Î Î¬ÏÏƒÎ¹Î¼Î¿ Î´Î¹Î±Î³ÏÎ½Î¹Î±
                for (const dc of [-1, 1]) {
                    if (isEnemy(r + dir, c + dc)) {
                        moves.push({ r: r + dir, c: c + dc });
                    }
                    
                    // En passant
                    if (enPassantTarget && enPassantTarget.r === r && enPassantTarget.c === c + dc) {
                        moves.push({ r: r + dir, c: c + dc });
                    }
                }
            }
            
            // ÎŠÏ€Ï€Î¿Ï‚
            if (p.type === 'n') {
                const knightMoves = [[-2, -1], [-2, 1], [-1, -2], [-1, 2], [1, -2], [1, 2], [2, -1], [2, 1]];
                knightMoves.forEach(([dr, dc]) => {
                    const rr = r + dr, cc = c + dc;
                    if (inBounds(rr, cc) && (isEmpty(rr, cc) || isEnemy(rr, cc))) {
                        moves.push({ r: rr, c: cc });
                    }
                });
            }
            
            // Î‘Î¾Î¹Ï‰Î¼Î±Ï„Î¹ÎºÏŒÏ‚, Î ÏÏÎ³Î¿Ï‚, Î’Î±ÏƒÎ¯Î»Î¹ÏƒÏƒÎ±
            if (['b', 'r', 'q'].includes(p.type)) {
                const directions = [];
                if (['b', 'q'].includes(p.type)) {
                    directions.push([-1, -1], [-1, 1], [1, -1], [1, 1]); // Î”Î¹Î±Î³ÏÎ½Î¹Î±
                }
                if (['r', 'q'].includes(p.type)) {
                    directions.push([-1, 0], [1, 0], [0, -1], [0, 1]); // ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î±/ÎšÎ±Î¸Î­Ï„Ï‰Ï‚
                }
                
                directions.forEach(([dr, dc]) => {
                    let rr = r + dr, cc = c + dc;
                    while (inBounds(rr, cc)) {
                        if (isEmpty(rr, cc)) {
                            moves.push({ r: rr, c: cc });
                        } else if (isEnemy(rr, cc)) {
                            moves.push({ r: rr, c: cc });
                            break;
                        } else {
                            break;
                        }
                        rr += dr;
                        cc += dc;
                    }
                });
            }
            
            // Î’Î±ÏƒÎ¹Î»Î¹Î¬Ï‚
            if (p.type === 'k') {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;
                        const rr = r + dr, cc = c + dc;
                        if (inBounds(rr, cc) && (isEmpty(rr, cc) || isEnemy(rr, cc))) {
                            moves.push({ r: rr, c: cc });
                        }
                    }
                }
                
                // Î•ÎºÏ„ÏÎ¿Ï€Î® (castling)
                if (color === 'w' && r === 7 && c === 4 && !isKingInCheck('w')) {
                    if (castlingRights.whiteKingside && isEmpty(7, 5) && isEmpty(7, 6)) {
                        moves.push({ r: 7, c: 6 });
                    }
                    if (castlingRights.whiteQueenside && isEmpty(7, 3) && isEmpty(7, 2) && isEmpty(7, 1)) {
                        moves.push({ r: 7, c: 2 });
                    }
                } else if (color === 'b' && r === 0 && c === 4 && !isKingInCheck('b')) {
                    if (castlingRights.blackKingside && isEmpty(0, 5) && isEmpty(0, 6)) {
                        moves.push({ r: 0, c: 6 });
                    }
                    if (castlingRights.blackQueenside && isEmpty(0, 3) && isEmpty(0, 2) && isEmpty(0, 1)) {
                        moves.push({ r: 0, c: 2 });
                    }
                }
            }
            
            return moves;
        }
        
        function isKingInCheck(color) {
            const kingPos = findKing(color);
            if (!kingPos) return false;
            
            const opponentColor = color === 'w' ? 'b' : 'w';
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && piece.color === opponentColor) {
                        const moves = generateMoves(r, c);
                        if (moves.some(move => move.r === kingPos.r && move.c === kingPos.c)) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }
        
        function findKing(color) {
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && piece.type === 'k' && piece.color === color) {
                        return { r, c };
                    }
                }
            }
            return null;
        }
        
        function hasAnyLegalMoves(color) {
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && piece.color === color) {
                        if (generateLegalMoves(r, c).length > 0) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        // ============================================
        // Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î— Î¤Î•Î›ÎŸÎ¥Î£ Î Î‘Î™Î§ÎÎ™Î”Î™ÎŸÎ¥
        // ============================================
        function checkGameState() {
            const currentColor = whiteToMove ? 'w' : 'b';
            kingInCheck = isKingInCheck(currentColor);
            
            const hasLegalMoves = hasAnyLegalMoves(currentColor);
            
            if (!hasLegalMoves) {
                gameActive = false;
                stopMidgameAdCountdown();
                hideMidgameIndicator();
                
                if (kingInCheck) {
                    // Checkmate
                    gameInfoEl.innerHTML = `<span class="status-mate">${currentColor === 'w' ? "ÎœÎ±Ï„! ÎÎ¹ÎºÎ¬Î½ Ï„Î± ÎœÎ±ÏÏÎ±" : "ÎœÎ±Ï„! ÎÎ¹ÎºÎ¬Î½ Ï„Î± Î›ÎµÏ…ÎºÎ¬"}</span>`;
                    showPostGameModal(currentColor === 'w' ? "ÎœÎ±ÏÏÎ±" : "Î›ÎµÏ…ÎºÎ¬", "checkmate");
                    showVictoryCelebration(currentColor === 'w' ? "ÎœÎ±ÏÏÎ±" : "Î›ÎµÏ…ÎºÎ¬");
                } else {
                    // Stalemate
                    gameInfoEl.textContent = "Î Î±Ï„! Î™ÏƒÎ¿Ï€Î±Î»Î¯Î±";
                    showPostGameModal(null, "stalemate");
                }
            } else if (kingInCheck) {
                gameInfoEl.innerHTML = `<span class="status-check">${currentColor === 'w' ? "Î£Î±Ï‡ ÏƒÏ„Î± Î›ÎµÏ…ÎºÎ¬!" : "Î£Î±Ï‡ ÏƒÏ„Î± ÎœÎ±ÏÏÎ±!"}</span>`;
            }
        }
        
        // ============================================
        // UI ÎšÎ‘Î™ Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£
        // ============================================
        function getPieceImg(type, color) {
            const pieceMap = {
                'pw': '4/45/Chess_plt45.svg',
                'pb': 'c/c7/Chess_pdt45.svg',
                'rw': '7/72/Chess_rlt45.svg',
                'rb': 'f/ff/Chess_rdt45.svg',
                'nw': '7/70/Chess_nlt45.svg',
                'nb': 'e/ef/Chess_ndt45.svg',
                'bw': 'b/b1/Chess_blt45.svg',
                'bb': '9/98/Chess_bdt45.svg',
                'qw': '1/15/Chess_qlt45.svg',
                'qb': '4/47/Chess_qdt45.svg',
                'kw': '4/42/Chess_klt45.svg',
                'kb': 'f/f0/Chess_kdt45.svg'
            };
            return `https://upload.wikimedia.org/wikipedia/commons/${pieceMap[type + color]}`;
        }
        
        function getPieceName(type) {
            const names = {
                'p': 'Î Î¹ÏŒÎ½Î¹',
                'r': 'Î ÏÏÎ³Î¿Ï‚',
                'n': 'ÎŠÏ€Ï€Î¿Ï‚',
                'b': 'Î‘Î¾Î¹Ï‰Î¼Î±Ï„Î¹ÎºÏŒÏ‚',
                'q': 'Î’Î±ÏƒÎ¯Î»Î¹ÏƒÏƒÎ±',
                'k': 'Î’Î±ÏƒÎ¹Î»Î¹Î¬Ï‚'
            };
            return names[type] || type;
        }
        
        function updateGameInfo() {
            if (!gameActive) return;
            
            if (kingInCheck) {
                gameInfoEl.innerHTML = `<span class="status-check">${whiteToMove ? "Î£Î±Ï‡ ÏƒÏ„Î± Î›ÎµÏ…ÎºÎ¬!" : "Î£Î±Ï‡ ÏƒÏ„Î± ÎœÎ±ÏÏÎ±!"}</span>`;
            } else {
                gameInfoEl.textContent = whiteToMove ? "Î Î±Î¯Î¶Î¿Ï…Î½ Ï„Î± Î›ÎµÏ…ÎºÎ¬" : "Î Î±Î¯Î¶Î¿Ï…Î½ Ï„Î± ÎœÎ±ÏÏÎ±";
            }
            
            if (vsAI) {
                const aiSide = aiColor === 'w' ? 'Î›ÎµÏ…ÎºÎ¬' : 'ÎœÎ±ÏÏÎ±';
                const aiLevel = getDifficultyName(selectedDifficulty);
                gameInfoEl.textContent += ` (AI: ${aiSide}, ${aiLevel})`;
            }
        }
        
        function getDifficultyName(level) {
            const names = {
                1: 'ÎÎµÎ¿Ï†ÏÏ„Î¹ÏƒÏ„Î¿Ï‚',
                2: 'Î•ÏÎºÎ¿Î»Î¿',
                3: 'ÎœÎ­Ï„ÏÎ¹Î¿',
                4: 'Î”ÏÏƒÎºÎ¿Î»Î¿',
                5: 'Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿',
                6: 'Î ÏÎ¿Ï†Î­ÏƒÎ¹Î¿Î½Î±Î»'
            };
            return names[level] || 'ÎœÎ­Ï„ÏÎ¹Î¿';
        }
        
        function getSearchDepth(level) {
            const depths = {
                1: 1,  // ÎÎµÎ¿Ï†ÏÏ„Î¹ÏƒÏ„Î¿Ï‚
                2: 2,  // Î•ÏÎºÎ¿Î»Î¿
                3: 3,  // ÎœÎ­Ï„ÏÎ¹Î¿
                4: 4,  // Î”ÏÏƒÎºÎ¿Î»Î¿
                5: 5,  // Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿
                6: 6   // Î ÏÎ¿Ï†Î­ÏƒÎ¹Î¿Î½Î±Î»
            };
            return depths[level] || 4;
        }
        
        function updateAIStrengthInfo() {
            const depth = getSearchDepth(selectedDifficulty);
            const times = {
                1: '~0.5-1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿',
                2: '~1-2 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±',
                3: '~2-4 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±',
                4: '~3-6 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±',
                5: '~5-10 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±',
                6: '~8-15 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±'
            };
            aiStrengthInfo.innerHTML = `Î’Î¬Î¸Î¿Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚: ${depth}<br>Î§ÏÏŒÎ½Î¿Ï‚: ${times[depth] || '~3-6 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±'}`;
        }
        
        // ============================================
        // Î”Î™Î‘Î¦Î—ÎœÎ™Î£Î•Î™Î£
        // ============================================
        function showFullscreenAd(type = "startup") {
            if (type === "startup") {
                adShown = true;
            } else {
                midgameAdShown = true;
            }
            
            hideMidgameIndicator();
            
            fullscreenAd.classList.add('show');
            adCountdownValue = 15;
            adTimerCount.textContent = adCountdownValue;
            
            setTimeout(() => {
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.log("Ad load error:", e);
                }
            }, 300);
            
            setTimeout(() => {
                fullscreenAd.classList.remove('show');
                fullscreenAd.classList.add('show-abrupt');
            }, 3000);
            
            startAdCountdown();
            
            clearTimeout(adTimer);
            adTimer = setTimeout(() => {
                closeFullscreenAdFunc(type);
            }, 15000);
        }
        
        function startAdCountdown() {
            clearInterval(adCountdownTimer);
            adCountdownTimer = setInterval(() => {
                adCountdownValue--;
                adTimerCount.textContent = adCountdownValue;
                
                if (adCountdownValue <= 0) {
                    clearInterval(adCountdownTimer);
                }
            }, 1000);
        }
        
        function closeFullscreenAdFunc(type = "startup") {
            fullscreenAd.classList.remove('show', 'show-abrupt');
            clearInterval(adCountdownTimer);
            clearTimeout(adTimer);
            
            if (type === "midgame") {
                setTimeout(() => {
                    midgameAdShown = false;
                    startMidgameAdCountdown();
                }, 60000);
            }
        }
        
        function startMidgameAdCountdown() {
            stopMidgameAdCountdown();
            
            let secondsLeft = 120;
            midgameTimer.textContent = secondsLeft;
            midgameAdIndicator.style.display = 'block';
            
            midgameCountdownTimer = setInterval(() => {
                secondsLeft--;
                midgameTimer.textContent = secondsLeft;
                
                if (secondsLeft <= 0) {
                    if (gameActive && !midgameAdShown) {
                        showFullscreenAd("midgame");
                    }
                    clearInterval(midgameCountdownTimer);
                    hideMidgameIndicator();
                }
            }, 1000);
            
            midgameAdTimeout = setTimeout(() => {
                if (gameActive && !midgameAdShown) {
                    showFullscreenAd("midgame");
                }
                hideMidgameIndicator();
            }, 120000);
        }
        
        function stopMidgameAdCountdown() {
            clearInterval(midgameCountdownTimer);
            clearTimeout(midgameAdTimeout);
            hideMidgameIndicator();
        }
        
        function hideMidgameIndicator() {
            midgameAdIndicator.style.display = 'none';
        }
        
        // ============================================
        // ÎœÎŸÎÎ¤Î‘Î› ÎšÎ‘Î™ Î•ÎŸÎ¡Î¤Î‘Î£Î¤Î™ÎšÎ‘
        // ============================================
        function showPostGameModal(winner, resultType) {
            if (resultType === "checkmate") {
                postGameTitle.textContent = "ğŸ‰ Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î±!";
                postGameMessage.textContent = `ÎÎ¯ÎºÎ· Î³Î¹Î± Ï„Î± ${winner}!`;
            } else if (resultType === "stalemate") {
                postGameTitle.textContent = "ğŸ¤ Î™ÏƒÎ¿Ï€Î±Î»Î¯Î±!";
                postGameMessage.textContent = "Î¤Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ Î­Î»Î·Î¾Îµ Î¹ÏƒÏŒÏ€Î±Î»Î¿.";
            }
            
            postGameModal.style.display = 'flex';
        }
        
        function showVictoryCelebration(winner) {
            winnerTextEl.textContent = winner ? `ÎÎ¯ÎºÎ· Î³Î¹Î± Ï„Î± ${winner}!` : "Î™ÏƒÎ¿Ï€Î±Î»Î¯Î±!";
            victoryMessageEl.style.display = 'block';
            
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± confetti
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement("div");
                confetti.className = "confetti";
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                celebrationEl.appendChild(confetti);
            }
            
            setTimeout(() => {
                victoryMessageEl.style.display = 'none';
                celebrationEl.innerHTML = '';
            }, 5000);
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById("resetBtn").addEventListener("click", () => {
            welcomeModal.style.display = 'flex';
            stopMidgameAdCountdown();
            hideMidgameIndicator();
        });
        
        document.getElementById("flipBtn").addEventListener("click", () => {
            flipped = !flipped;
            render();
        });
        
        document.getElementById("aiBtn").addEventListener("click", () => {
            welcomeModal.style.display = 'flex';
        });
        
        // Game mode selection
        document.querySelectorAll(".game-mode-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".game-mode-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                selectedGameMode = btn.dataset.mode;
                
                if (selectedGameMode === 'vsAI') {
                    document.getElementById("difficultySelector").style.display = 'flex';
                } else {
                    document.getElementById("difficultySelector").style.display = 'none';
                }
            });
        });
        
        // Difficulty selection
        document.querySelectorAll(".difficulty-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".difficulty-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                selectedDifficulty = parseInt(btn.dataset.depth);
                updateAIStrengthInfo();
            });
        });
        
        // Start Game Button
        document.getElementById("startGameBtn").addEventListener("click", () => {
            welcomeModal.style.display = 'none';
            initGame();
        });
        
        // Post-game buttons
        playAgainBtn.addEventListener("click", () => {
            postGameModal.style.display = 'none';
            welcomeModal.style.display = 'flex';
            stopMidgameAdCountdown();
            hideMidgameIndicator();
        });
        
        mainMenuBtn.addEventListener("click", () => {
            postGameModal.style.display = 'none';
            welcomeModal.style.display = 'flex';
            stopMidgameAdCountdown();
            hideMidgameIndicator();
        });
        
        // Close Fullscreen Ad
        closeFullscreenAd.addEventListener("click", () => {
            const type = midgameAdShown ? "midgame" : "startup";
            closeFullscreenAdFunc(type);
        });
        
        fullscreenAd.addEventListener("click", (e) => {
            if (e.clientY < window.innerHeight / 2) {
                const type = midgameAdShown ? "midgame" : "startup";
                closeFullscreenAdFunc(type);
            }
        });
        
        // Show welcome modal on load
        window.addEventListener('DOMContentLoaded', () => {
            welcomeModal.style.display = 'flex';
        });
    </script>
</body>
</html>
